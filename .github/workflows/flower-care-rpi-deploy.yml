name: Flower-care-ci

on:
  push:
    #branches:
    #  - main
    tags:
      - "v*.*.*"
  pull_request:
    branches:
      - main

env:
    REGISTRY: ghcr.io

# Needed for nx-set-shas within nx-cloud-main.yml, when run on the main branch
permissions:
  actions: read
  contents: read
  packages: write

jobs:
  build-with-docker-engine:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log into registry
          uses: docker/login-action@v3
          with:
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - uses: actions/setup-node@v4
          with:
            cache: 'yarn'
            node-version-file: '.nvmrc'
            cache-dependency-path: 'yarn.lock'

        - name: 'Install node-gyp'
          run: yarn global add node-gyp

        - name: 'Install Dependencies'
          run: yarn install --frozen-lockfile

        - name: Derive appropriate SHAs for base and head for `nx affected` commands
          uses: nrwl/nx-set-shas@v3

        - name: 'Build'
          run: yarn nx affected --base=$NX_BASE --head=$NX_HEAD --target=build --configuration=production --parallel=2
        
        - name: Docker meta
          id: meta
          uses: docker/metadata-action@v5
          with:
            # list of Docker images to use as base name for tags
            images: |
              ghcr.io/battlefieldnoob/flower-care-rpi           
            # generate Docker tags based on the following events/attributes
            tags: |
              "type=schedule",
              "type=ref,event=branch",
              "type=ref,event=tag",
              "type=ref,event=pr",
              "type=sha,prefix=sha-",
              "type=semver,pattern={{version}}",
              "type=semver,pattern={{major}}.{{minor}}",
              "type=semver,pattern={{major}}"
        
        - name: 'Image build and push'
          run: INPUT_GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} yarn nx affected --base=$NX_BASE --head=$NX_HEAD --target=container --configuration=production --parallel=2
        #- uses: docker/build-push-action@v5
        #  with:
        #    file: ./apps/flower-care-rpi/Dockerfile
        #    context: .
        #    push: true
        #    platforms: linux/arm64
        #    cache-from: type=gha
        #    cache-to: type=gha,mode=max
        #    tags: ${{ steps.meta.outputs.tags }}
        #    labels: ${{ steps.meta.outputs.labels }}
