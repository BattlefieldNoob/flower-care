# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build flower-care-rpi`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t flower-care-rpi`.
FROM nikolaik/python-nodejs:python3.12-nodejs20-slim as builder

WORKDIR /app

RUN addgroup --system flower-care-rpi && \
          useradd --system -g flower-care-rpi flower-care-rpi

RUN apt update && apt install -y build-essential libudev-dev git

RUN yarn global add node-gyp

COPY package.json yarn.lock ./

RUN yarn install --frozen-lockfile --prefer-offline

COPY . .

ARG NX_BASE
ARG NX_HEAD
ARG CONFIG

RUN yarn nx affected --base=${NX_BASE} --head=${NX_HEAD} --target=build --configuration=${CONFIG} --parallel=3

RUN cd dist/apps/flower-care-rpi && yarn install --frozen-lockfile --prefer-offline --production

FROM docker.io/node:lts-slim

WORKDIR /app

COPY --from=builder app/dist/apps/flower-care-rpi  flower-care-rpi

RUN addgroup --system flower-care-rpi && \
          useradd --system -g flower-care-rpi flower-care-rpi

# TODO test with production env
#RUN chown -R flower-care-rpi:flower-care-rpi .

CMD [ "node", "flower-care-rpi" ]
